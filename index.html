<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="FamilyBudget"/>
  <meta name="theme-color" content="#1e1b4b"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icon.svg"/>
  <title>FamilyBudget</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;background:#1e1b4b;overscroll-behavior:none;}
    #root{min-height:100%;}
    input,select,button{font-family:inherit;}
    input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;}
    ::-webkit-scrollbar{width:4px;}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:2px;}
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script>

const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const CURRENCIES = ["SGD","USD","INR"];

const DEFAULT_EXPENSE_CATS = [
  { name: "Housing & Utilities", icon: "ðŸ ", color: "#4A90D9" },
  { name: "Groceries & Food", icon: "ðŸ›’", color: "#E67E22" },
  { name: "Transport", icon: "ðŸš—", color: "#8E44AD" },
  { name: "Children â€” School Fees", icon: "ðŸ«", color: "#F39C12" },
  { name: "Children â€” Tuition", icon: "ðŸ“š", color: "#F39C12" },
  { name: "Children â€” Activities", icon: "âš½", color: "#F39C12" },
  { name: "Children â€” Misc", icon: "ðŸŽ’", color: "#F39C12" },
  { name: "Insurance", icon: "ðŸ›¡ï¸", color: "#27AE60" },
  { name: "Healthcare", icon: "ðŸ¥", color: "#E74C3C" },
  { name: "Personal & Lifestyle", icon: "âœ¨", color: "#16A085" },
  { name: "Entertainment", icon: "ðŸŽ¬", color: "#2980B9" },
  { name: "Subscriptions", icon: "ðŸ“±", color: "#7F8C8D" },
  { name: "Domestic Help", icon: "ðŸ§¹", color: "#95A5A6" },
  { name: "Travel & Holidays", icon: "âœˆï¸", color: "#1ABC9C" },
  { name: "Savings & Investments", icon: "ðŸ’°", color: "#27AE60" },
  { name: "Other", icon: "ðŸ“¦", color: "#BDC3C7" },
];

const DEFAULT_INCOME_CATS = [
  { name: "Salary â€” Person 1", icon: "ðŸ‘¤", color: "#27AE60" },
  { name: "Salary â€” Person 2", icon: "ðŸ‘¤", color: "#2ECC71" },
  { name: "Bonus / Incentive", icon: "ðŸŽ¯", color: "#27AE60" },
  { name: "Rental Income", icon: "ðŸ¢", color: "#27AE60" },
  { name: "Other Income", icon: "ðŸ’µ", color: "#27AE60" },
];

const currSym = c => c==="INR"?"â‚¹":c==="USD"?"$":"S$";
const todayStr = () => new Date().toISOString().slice(0,10);
const monthFromDate = d => MONTHS[new Date(d).getMonth()];
const yearFromDate = d => new Date(d).getFullYear();

const STORE_KEY = "fambudget_v4";
const loadData = () => { try { const r=localStorage.getItem(STORE_KEY); return r?JSON.parse(r):null; } catch{return null;} };
const saveData = d => { try { localStorage.setItem(STORE_KEY,JSON.stringify(d)); } catch{} };
const initData = () => ({ 
  baseCurrency:"SGD",
  fxRates:{},
  availableYears:[2026,2027,2028,2029,2030],
  entries:[], 
  receipts:{},
  expenseCategories: DEFAULT_EXPENSE_CATS,
  incomeCategories: DEFAULT_INCOME_CATS
});

const { useState, useEffect, useRef } = React;

function Toast({msg,onDone}) {
  useEffect(()=>{const t=setTimeout(onDone,2000);return()=>clearTimeout(t);},[]);
  return React.createElement('div',{style:{position:"fixed",bottom:28,left:"50%",transform:"translateX(-50%)",background:"#1a1a2e",color:"#fff",padding:"11px 24px",borderRadius:40,fontSize:13,fontWeight:700,zIndex:9999,boxShadow:"0 8px 32px rgba(0,0,0,0.4)",display:"flex",alignItems:"center",gap:8}},
    React.createElement('span',{style:{color:"#4ade80"}},"âœ“")," ",msg);
}

function CatPill({cat,selected,onClick}) {
  const active = selected===cat.name;
  return React.createElement('button',{onClick:()=>onClick(cat.name),style:{display:"flex",alignItems:"center",gap:5,padding:"9px 13px",borderRadius:30,border:`2px solid ${active?cat.color:"#e5e7eb"}`,background:active?`${cat.color}18`:"#f9fafb",color:active?cat.color:"#6b7280",fontSize:13,fontWeight:active?700:500,cursor:"pointer",transition:"all .15s",whiteSpace:"nowrap"}},
    React.createElement('span',null,cat.icon),React.createElement('span',null,cat.name));
}

function App() {
  const [data,setData] = useState(()=>loadData()||initData());
  const [view,setView] = useState("log");
  const [type,setType] = useState("expense");
  const [category,setCategory] = useState("");
  const [amount,setAmount] = useState("");
  const [entryCurrency,setEntryCurrency] = useState(data.baseCurrency||"SGD");
  const [notes,setNotes] = useState("");
  const [entryDate,setEntryDate] = useState(todayStr());
  const [filterMonth,setFilterMonth] = useState(MONTHS[new Date().getMonth()]);
  const [filterYear,setFilterYear] = useState((data.availableYears||[2026])[0]);
  const [toast,setToast] = useState(null);
  const [editId,setEditId] = useState(null);
  const [delConfirm,setDelConfirm] = useState(null);
  const [receiptImg,setReceiptImg] = useState(null);
  const [showSettings,setShowSettings] = useState(false);
  const [editCatType,setEditCatType] = useState("expense");
  const [editingCat,setEditingCat] = useState(null);
  const [newCatName,setNewCatName] = useState("");
  const [newCatIcon,setNewCatIcon] = useState("ðŸ“¦");
  const [newCatColor,setNewCatColor] = useState("#4A90D9");
  const [showResetConfirm,setShowResetConfirm] = useState(false);
  const [showFxModal,setShowFxModal] = useState(false);
  const [newYear,setNewYear] = useState("");
  const amtRef = useRef();

  useEffect(()=>{
    const timer = setTimeout(()=>saveData(data),500);
    return ()=>clearTimeout(timer);
  },[data]);

  const cats = type==="expense"?(data.expenseCategories||DEFAULT_EXPENSE_CATS):(data.incomeCategories||DEFAULT_INCOME_CATS);
  const showToast = m=>setToast(m);
  const years = data.availableYears||[2026];

  const convertToBase = (amt,curr,date) => {
    if(curr===data.baseCurrency) return amt;
    const rateKey = `${curr}_${data.baseCurrency}_${date}`;
    const rate = data.fxRates?.[rateKey];
    if(rate) return amt * rate;
    return amt;
  };

  const fmt = (n,c) => `${currSym(c||data.baseCurrency)}${Math.abs(Number(n)).toLocaleString("en-SG",{minimumFractionDigits:2,maximumFractionDigits:2})}`;

  const handleSubmit = () => {
    if(!category) return showToast("Pick a category");
    if(!amount||isNaN(amount)||Number(amount)<=0) return showToast("Enter valid amount");
    
    const month=monthFromDate(entryDate), year=yearFromDate(entryDate);
    const amt = Number(amount);
    
    if(entryCurrency !== data.baseCurrency) {
      const rateKey = `${entryCurrency}_${data.baseCurrency}_${entryDate}`;
      if(!data.fxRates?.[rateKey]) {
        setShowFxModal(true);
        return;
      }
    }

    if(editId){
      setData(p=>({...p,entries:p.entries.map(e=>e.id===editId?{...e,date:entryDate,month,year,type,category,amount:amt,currency:entryCurrency,notes}:e)}));
      setEditId(null); showToast("Updated!");
    } else {
      const newId=Date.now();
      const newEntry={id:newId,date:entryDate,month,year,type,category,amount:amt,currency:entryCurrency,notes};
      setData(p=>{
        const updated={...p,entries:[...p.entries,newEntry]};
        if(receiptImg) updated.receipts={...(p.receipts||{}),[newId]:receiptImg};
        return updated;
      });
      showToast(type==="expense"?"Expense logged!":"Income logged!");
    }
    setAmount(""); setNotes(""); setCategory(""); setReceiptImg(null); setEntryCurrency(data.baseCurrency);
    setTimeout(()=>amtRef.current?.focus(),50);
  };

  const saveFxRate = (rate) => {
    const rateKey = `${entryCurrency}_${data.baseCurrency}_${entryDate}`;
    setData(p=>({...p,fxRates:{...(p.fxRates||{}),[rateKey]:Number(rate)}}));
    setShowFxModal(false);
    setTimeout(handleSubmit,100);
  };

  const handleEdit = e=>{setEditId(e.id);setType(e.type);setCategory(e.category);setAmount(String(e.amount));setEntryCurrency(e.currency||data.baseCurrency);setNotes(e.notes||"");setEntryDate(e.date);setView("log");};
  const handleDelete = id=>{setData(p=>({...p,entries:p.entries.filter(e=>e.id!==id)}));setDelConfirm(null);showToast("Deleted");};

  const monthEntries=(m,y)=>data.entries.filter(e=>e.month===m&&e.year===y);
  const monthTotal=(m,y,t)=>monthEntries(m,y).filter(e=>e.type===t).reduce((s,e)=>s+convertToBase(e.amount,e.currency,e.date),0);
  const catTotal=(m,y,c)=>monthEntries(m,y).filter(e=>e.category===c).reduce((s,e)=>s+convertToBase(e.amount,e.currency,e.date),0);
  const allCats=[...(data.expenseCategories||DEFAULT_EXPENSE_CATS),...(data.incomeCategories||DEFAULT_INCOME_CATS)];
  const getCat=name=>allCats.find(c=>c.name===name)||{icon:"ðŸ“¦",color:"#ccc"};

  const exportCSV=()=>{
    const rows=[["Date","Month","Year","Type","Category","Amount","Currency","Amount in "+data.baseCurrency,"Notes"]];
    monthEntries(filterMonth,filterYear).forEach(e=>rows.push([e.date,e.month,e.year,e.type,e.category,e.amount,e.currency,convertToBase(e.amount,e.currency,e.date).toFixed(2),e.notes||""]));
    const csv=rows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download=`budget_${filterMonth}_${filterYear}.csv`;a.click();
    showToast("CSV exported!");
  };

  const handleReceiptUpload = e=>{
    const file=e.target.files[0];
    if(!file) return;
    if(!file.type.startsWith('image/')) return showToast("Select an image");
    if(file.size>5*1024*1024) return showToast("Image too large (max 5MB)");
    const reader=new FileReader();
    reader.onload=ev=>{setReceiptImg(ev.target.result);showToast("Receipt attached!");};
    reader.readAsDataURL(file);
  };

  const removeReceipt=()=>{setReceiptImg(null);showToast("Receipt removed");};
  const viewReceipt=id=>{
    const img=data.receipts?.[id];
    if(!img) return;
    const win=window.open();
    win.document.write(`<html><head><title>Receipt</title><style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#000;}</style></head><body><img src="${img}" style="max-width:100%;max-height:100vh;"/></body></html>`);
  };

  const handleBackup=()=>{
    const backup={version:"2.0",exportDate:new Date().toISOString(),data};
    const json=JSON.stringify(backup,null,2);
    const blob=new Blob([json],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download=`FamilyBudget_Backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    showToast("Backup downloaded!");
  };

  const handleRestore=()=>{
    const input=document.createElement("input");
    input.type="file";input.accept=".json";
    input.onchange=e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=event=>{
        try{
          const backup=JSON.parse(event.target.result);
          if(!backup.data||!backup.data.entries) return showToast("Invalid backup");
          if(data.entries.length>0){
            if(confirm(`Replace ${data.entries.length} entries with backup (${backup.data.entries.length} entries)?`)){
              setData(backup.data);showToast(`Restored ${backup.data.entries.length} entries!`);
            }
          } else {
            setData(backup.data);showToast(`Restored ${backup.data.entries.length} entries!`);
          }
        }catch{showToast("Error reading file");}
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const addCategory=()=>{
    if(!newCatName.trim()) return showToast("Enter category name");
    const newCat={name:newCatName.trim(),icon:newCatIcon,color:newCatColor};
    setData(p=>({
      ...p,
      [editCatType==="expense"?"expenseCategories":"incomeCategories"]:[
        ...(editCatType==="expense"?p.expenseCategories||DEFAULT_EXPENSE_CATS:p.incomeCategories||DEFAULT_INCOME_CATS),
        newCat
      ]
    }));
    setNewCatName("");setNewCatIcon("ðŸ“¦");setNewCatColor("#4A90D9");
    showToast("Category added!");
  };

  const updateCategory=idx=>{
    if(!newCatName.trim()) return showToast("Enter category name");
    setData(p=>{
      const key=editCatType==="expense"?"expenseCategories":"incomeCategories";
      const cats=[...(p[key]||[])];
      cats[idx]={...cats[idx],name:newCatName.trim(),icon:newCatIcon,color:newCatColor};
      return {...p,[key]:cats};
    });
    setEditingCat(null);setNewCatName("");setNewCatIcon("ðŸ“¦");setNewCatColor("#4A90D9");
    showToast("Category updated!");
  };

  const deleteCategory=idx=>{
    if(!confirm("Delete this category?")) return;
    setData(p=>{
      const key=editCatType==="expense"?"expenseCategories":"incomeCategories";
      const cats=[...(p[key]||[])];
      cats.splice(idx,1);
      return {...p,[key]:cats};
    });
    showToast("Category deleted!");
  };

  const startEditCategory=(idx,cat)=>{
    setEditingCat(idx);setNewCatName(cat.name);setNewCatIcon(cat.icon);setNewCatColor(cat.color);
  };

  const addYear=()=>{
    const y = parseInt(newYear);
    if(!y || y<2020 || y>2050) return showToast("Enter year 2020-2050");
    if(years.includes(y)) return showToast("Year already exists");
    setData(p=>({...p,availableYears:[...years,y].sort((a,b)=>a-b)}));
    setNewYear("");
    showToast("Year added!");
  };

  const deleteYear=(y)=>{
    if(years.length<=1) return showToast("Need at least 1 year");
    setData(p=>({...p,availableYears:years.filter(yr=>yr!==y)}));
    showToast("Year removed!");
  };

  const resetAllData=()=>{
    if(!showResetConfirm){
      setShowResetConfirm(true);
      return;
    }
    setData(initData());
    setShowResetConfirm(false);
    setShowSettings(false);
    showToast("All data reset!");
  };

  const h=React.createElement;
  const card={background:"#fff",borderRadius:18,padding:20,boxShadow:"0 4px 24px rgba(0,0,0,0.10)",marginBottom:14};
  const sec={fontSize:11,fontWeight:700,color:"#9ca3af",letterSpacing:1.5,textTransform:"uppercase",marginBottom:12};
  const inp={width:"100%",padding:"12px 14px",border:"2px solid #e5e7eb",borderRadius:12,fontSize:15,outline:"none",fontFamily:"inherit",background:"#fafafa",boxSizing:"border-box"};

  const LogView=()=>h('div',null,
    h('div',{style:{...card,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",padding:"12px 16px"}},
      h('span',{style:{fontSize:12,fontWeight:700,color:"#6b7280"}},"Base:"),
      CURRENCIES.map(c=>h('button',{key:c,onClick:()=>setData(p=>({...p,baseCurrency:c})),style:{padding:"5px 12px",borderRadius:20,fontSize:12,fontWeight:700,border:`2px solid ${data.baseCurrency===c?"#1e1b4b":"#e5e7eb"}`,background:data.baseCurrency===c?"#1e1b4b":"#fff",color:data.baseCurrency===c?"#fff":"#6b7280",cursor:"pointer"}},c)),
      h('button',{onClick:handleBackup,style:{marginLeft:"auto",padding:"6px 12px",background:"#16a34a",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"ðŸ’¾")
    ),
    h('div',{style:card},
      editId&&h('div',{style:{background:"#fefce8",border:"1px solid #fde68a",borderRadius:10,padding:"10px 14px",marginBottom:16,display:"flex",justifyContent:"space-between"}},
        h('span',{style:{fontSize:13,fontWeight:700,color:"#92400e"}},"âœï¸ Editing"),
        h('button',{onClick:()=>{setEditId(null);setAmount("");setNotes("");setCategory("");},style:{background:"none",border:"none",cursor:"pointer",color:"#92400e",fontWeight:700,fontSize:18}},"âœ•")
      ),
      h('div',{style:{display:"flex",borderRadius:12,overflow:"hidden",border:"2px solid #e5e7eb",marginBottom:18}},
        [["expense","ðŸ’¸ Expense","#ef4444"],["income","ðŸ’µ Income","#22c55e"]].map(([t,l,col])=>
          h('button',{key:t,onClick:()=>{setType(t);setCategory("");},style:{flex:1,padding:"12px 0",border:"none",cursor:"pointer",background:type===t?col:"transparent",color:type===t?"#fff":"#9ca3af",fontWeight:700,fontSize:14}},l)
        )
      ),
      h('p',{style:sec},"Date"),
      h('input',{type:"date",value:entryDate,onChange:e=>setEntryDate(e.target.value),style:{...inp,marginBottom:16,fontSize:14}}),
      h('p',{style:sec},"Category"),
      h('div',{style:{display:"flex",flexWrap:"wrap",gap:7,marginBottom:18,maxHeight:170,overflowY:"auto"}},
        cats.map(cat=>h(CatPill,{key:cat.name,cat,selected:category,onClick:setCategory}))
      ),
      h('p',{style:sec},"Amount & Currency"),
      h('div',{style:{display:"flex",gap:8,marginBottom:16}},
        h('div',{style:{position:"relative",flex:1}},
          h('span',{style:{position:"absolute",left:14,top:"50%",transform:"translateY(-50%)",fontSize:20,fontWeight:800,color:"#1e1b4b"}},currSym(entryCurrency)),
          h('input',{ref:amtRef,type:"number",inputMode:"decimal",value:amount,onChange:e=>setAmount(e.target.value),placeholder:"0.00",style:{...inp,paddingLeft:46,fontSize:24,fontWeight:800,color:"#1e1b4b",border:"2px solid #1e1b4b",background:"#f5f3ff",margin:0}})
        ),
        h('select',{value:entryCurrency,onChange:e=>setEntryCurrency(e.target.value),style:{...inp,width:90,padding:"12px 10px",fontSize:14,margin:0}},CURRENCIES.map(c=>h('option',{key:c,value:c},c)))
      ),
      h('p',{style:sec},"Notes (optional)"),
      h('input',{type:"text",value:notes,onChange:e=>setNotes(e.target.value),placeholder:"e.g. NTUC groceries...",style:{...inp,marginBottom:18}}),
      h('p',{style:sec},"Receipt (optional)"),
      !receiptImg
        ?h('label',{style:{display:"block",padding:"14px",border:"2px dashed #d1d5db",borderRadius:12,textAlign:"center",cursor:"pointer",background:"#fafafa",marginBottom:18}},
          h('input',{type:"file",accept:"image/*",onChange:handleReceiptUpload,style:{display:"none"}}),
          h('div',{style:{fontSize:13,color:"#9ca3af"}},"ðŸ“¸ Camera or ðŸ–¼ï¸ Photos")
        )
        :h('div',{style:{position:"relative",marginBottom:18}},
          h('img',{src:receiptImg,style:{width:"100%",maxHeight:200,objectFit:"contain",borderRadius:12,border:"2px solid #e5e7eb"}}),
          h('button',{onClick:removeReceipt,style:{position:"absolute",top:8,right:8,background:"rgba(239,68,68,0.9)",color:"#fff",border:"none",borderRadius:"50%",width:32,height:32,cursor:"pointer",fontSize:16}},"âœ•")
        ),
      h('button',{onClick:handleSubmit,disabled:!category||!amount,style:{width:"100%",padding:15,border:"none",borderRadius:14,background:(!category||!amount)?"#e5e7eb":"linear-gradient(135deg,#1e1b4b,#312e81)",color:(!category||!amount)?"#9ca3af":"#fff",fontWeight:800,fontSize:15,cursor:(!category||!amount)?"not-allowed":"pointer"}},
        editId?"âœï¸ Update":`+ Log ${type==="expense"?"Expense":"Income"}`)
    ),
    h('div',{style:card},
      h('p',{style:sec},"Recent Entries"),
      data.entries.length===0&&h('p',{style:{color:"#9ca3af",textAlign:"center",padding:"24px 0",fontSize:14}},"No entries yet"),
      [...data.entries].reverse().slice(0,8).map(e=>{
        const cat=getCat(e.category);
        return h('div',{key:e.id,style:{display:"flex",alignItems:"center",gap:12,padding:"12px 0",borderBottom:"1px solid #f3f4f6"}},
          h('div',{style:{width:42,height:42,borderRadius:12,flexShrink:0,background:`${cat.color}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:19}},cat.icon),
          h('div',{style:{flex:1,minWidth:0}},
            h('div',{style:{fontWeight:700,fontSize:13,color:"#111827"}},e.category),
            h('div',{style:{fontSize:11,color:"#9ca3af"}},e.date+(e.notes?` Â· ${e.notes}`:""))
          ),
          h('div',{style:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}},
            data.receipts?.[e.id]&&h('button',{onClick:()=>viewReceipt(e.id),style:{background:"#dbeafe",border:"none",borderRadius:6,padding:"4px 8px",fontSize:11,cursor:"pointer"}},"ðŸ“Ž"),
            h('div',{style:{fontWeight:800,fontSize:14,color:e.type==="expense"?"#ef4444":"#22c55e"}},
              (e.type==="expense"?"âˆ’":"+")+fmt(e.amount,e.currency)),
            e.currency!==data.baseCurrency&&h('div',{style:{fontSize:10,color:"#9ca3af"}},`â‰ˆ${fmt(convertToBase(e.amount,e.currency,e.date),data.baseCurrency)}`)
          ),
          h('button',{onClick:()=>handleEdit(e),style:{background:"#f3f4f6",border:"none",borderRadius:8,width:32,height:32,cursor:"pointer",fontSize:14}},"âœï¸"),
          h('button',{onClick:()=>setDelConfirm(e.id),style:{background:"#fee2e2",border:"none",borderRadius:8,width:32,height:32,cursor:"pointer",fontSize:14}},"ðŸ—‘")
        );
      })
    )
  );

  const HistoryView=()=>{
    const entries=[...monthEntries(filterMonth,filterYear)].reverse();
    const inc=monthTotal(filterMonth,filterYear,"income");
    const exp=monthTotal(filterMonth,filterYear,"expense");
    return h('div',null,
      h('div',{style:{...card,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",padding:"12px 16px"}},
        h('select',{value:filterMonth,onChange:e=>setFilterMonth(e.target.value),style:{...inp,width:"auto",padding:"7px 12px",fontSize:13}},MONTHS.map(m=>h('option',{key:m},m))),
        h('select',{value:filterYear,onChange:e=>setFilterYear(Number(e.target.value)),style:{...inp,width:85,padding:"7px 12px",fontSize:13}},years.map(y=>h('option',{key:y},y))),
        h('div',{style:{marginLeft:"auto",display:"flex",gap:6}},
          h('button',{onClick:handleBackup,style:{padding:"7px 14px",background:"#16a34a",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"ðŸ’¾"),
          h('button',{onClick:handleRestore,style:{padding:"7px 14px",background:"#7c3aed",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"ðŸ“¥"),
          h('button',{onClick:exportCSV,style:{padding:"7px 14px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"â¬‡ CSV")
        )
      ),
      h('div',{style:{...card,display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}},
        [["Income",inc,"#22c55e","#f0fdf4","ðŸ’µ"],["Expenses",exp,"#ef4444","#fef2f2","ðŸ’¸"],["Net",inc-exp,inc-exp>=0?"#3b82f6":"#ef4444","#eff6ff","ðŸ“Š"]].map(([l,v,col,bg,ic])=>
          h('div',{key:l,style:{textAlign:"center",padding:"12px 6px",background:bg,borderRadius:12}},
            h('div',{style:{fontSize:18}},ic),
            h('div',{style:{fontSize:10,color:"#9ca3af",fontWeight:700,margin:"4px 0 2px",textTransform:"uppercase"}},l),
            h('div',{style:{fontSize:12,fontWeight:800,color:col}},(v<0?"âˆ’":"")+fmt(Math.abs(v),data.baseCurrency))
          )
        )
      ),
      h('div',{style:card},
        h('p',{style:sec},`${filterMonth} ${filterYear} â€” ${entries.length} entries (in ${data.baseCurrency})`),
        entries.length===0&&h('p',{style:{color:"#9ca3af",textAlign:"center",padding:"24px 0",fontSize:14}},"No entries"),
        entries.map(e=>{
          const cat=getCat(e.category);
          return h('div',{key:e.id,style:{display:"flex",alignItems:"center",gap:12,padding:"12px 0",borderBottom:"1px solid #f3f4f6"}},
            h('div',{style:{width:40,height:40,borderRadius:11,flexShrink:0,background:`${cat.color}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}},cat.icon),
            h('div',{style:{flex:1,minWidth:0}},
              h('div',{style:{fontWeight:700,fontSize:13,color:"#111827"}},e.category),
              h('div',{style:{fontSize:11,color:"#9ca3af"}},e.date+(e.notes?` Â· ${e.notes}`:""))
            ),
            h('div',{style:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}},
              data.receipts?.[e.id]&&h('button',{onClick:()=>viewReceipt(e.id),style:{background:"#dbeafe",border:"none",borderRadius:6,padding:"4px 8px",fontSize:11,cursor:"pointer"}},"ðŸ“Ž"),
              h('div',{style:{fontWeight:800,fontSize:14,color:e.type==="expense"?"#ef4444":"#22c55e"}},
                (e.type==="expense"?"âˆ’":"+")+fmt(convertToBase(e.amount,e.currency,e.date),data.baseCurrency)),
              e.currency!==data.baseCurrency&&h('div',{style:{fontSize:10,color:"#9ca3af"}},`${fmt(e.amount,e.currency)}`)
            ),
            h('button',{onClick:()=>handleEdit(e),style:{background:"#f3f4f6",border:"none",borderRadius:8,width:30,height:30,cursor:"pointer",fontSize:13}},"âœï¸"),
            h('button',{onClick:()=>setDelConfirm(e.id),style:{background:"#fee2e2",border:"none",borderRadius:8,width:30,height:30,cursor:"pointer",fontSize:13}},"ðŸ—‘")
          );
        })
      )
    );
  };

  const SummaryView=()=>{
    const inc=monthTotal(filterMonth,filterYear,"income");
    const exp=monthTotal(filterMonth,filterYear,"expense");
    const net=inc-exp;
    const rate=inc>0?(net/inc*100).toFixed(1):"â€”";
    const childCats=["Children â€” School Fees","Children â€” Tuition","Children â€” Activities","Children â€” Misc"];
    const childTotal=childCats.reduce((s,c)=>s+catTotal(filterMonth,filterYear,c),0);
    return h('div',null,
      h('div',{style:{...card,display:"flex",gap:8,alignItems:"center",padding:"12px 16px"}},
        h('select',{value:filterMonth,onChange:e=>setFilterMonth(e.target.value),style:{...inp,width:"auto",padding:"7px 12px",fontSize:13}},MONTHS.map(m=>h('option',{key:m},m))),
        h('select',{value:filterYear,onChange:e=>setFilterYear(Number(e.target.value)),style:{...inp,width:85,padding:"7px 12px",fontSize:13}},years.map(y=>h('option',{key:y},y)))
      ),
      h('div',{style:card},
        h('p',{style:sec},`Summary â€” ${filterMonth} ${filterYear} (in ${data.baseCurrency})`),
        h('div',{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:20}},
          [["Total Income",fmt(inc,data.baseCurrency),"#16a34a","#f0fdf4","ðŸ’µ"],
           ["Total Expenses",fmt(exp,data.baseCurrency),"#dc2626","#fef2f2","ðŸ’¸"],
           ["Net Savings",(net<0?"âˆ’":"")+fmt(Math.abs(net),data.baseCurrency),net>=0?"#2563eb":"#dc2626","#eff6ff","ðŸ’°"],
           ["Savings Rate",`${rate}%`,"#7c3aed","#f5f3ff","ðŸ“Š"]
          ].map(([l,v,col,bg,ic])=>
            h('div',{key:l,style:{padding:"16px 14px",borderRadius:14,background:bg}},
              h('div',{style:{fontSize:22}},ic),
              h('div',{style:{fontSize:10,color:"#9ca3af",fontWeight:700,marginTop:6,textTransform:"uppercase",letterSpacing:1}},l),
              h('div',{style:{fontSize:16,fontWeight:800,color:col,marginTop:3}},v)
            )
          )
        ),
        h('p',{style:sec},"Expense Breakdown"),
        exp===0
          ?h('p',{style:{color:"#9ca3af",fontSize:13,textAlign:"center",padding:"12px 0"}},"No expenses")
          :(data.expenseCategories||DEFAULT_EXPENSE_CATS).map(cat=>{
              const t=catTotal(filterMonth,filterYear,cat.name);
              if(!t)return null;
              const pct=exp>0?Math.min(100,(t/exp)*100):0;
              return h('div',{key:cat.name,style:{marginBottom:10}},
                h('div',{style:{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:4}},
                  h('span',{style:{fontWeight:600,color:"#374151"}},`${cat.icon} ${cat.name}`),
                  h('span',{style:{fontWeight:700,color:cat.color}},`${fmt(t,data.baseCurrency)} `,h('span',{style:{color:"#9ca3af",fontWeight:400}},`(${pct.toFixed(1)}%)`))
                ),
                h('div',{style:{height:6,borderRadius:4,background:"#f3f4f6",overflow:"hidden"}},
                  h('div',{style:{height:"100%",borderRadius:4,background:cat.color,width:`${pct}%`,transition:"width .5s ease"}})
                )
              );
            }),
        childTotal>0&&h('div',null,
          h('p',{style:{...sec,marginTop:20}},"ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Children's Costs"),
          childCats.map(cn=>{
            const t=catTotal(filterMonth,filterYear,cn);
            if(!t)return null;
            return h('div',{key:cn,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"10px 14px",borderRadius:10,marginBottom:6,background:"#fefce8",borderLeft:"3px solid #f59e0b"}},
              h('span',{style:{fontSize:13,fontWeight:600,color:"#374151"}},cn),
              h('span',{style:{fontWeight:700,color:"#d97706"}},fmt(t,data.baseCurrency))
            );
          }),
          h('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"12px 14px",borderRadius:10,background:"#fef3c7",borderLeft:"3px solid #f59e0b"}},
            h('span',{style:{fontWeight:800,color:"#92400e"}},"Total Children"),
            h('span',{style:{fontWeight:800,color:"#d97706",fontSize:16}},fmt(childTotal,data.baseCurrency))
          )
        )
      ),
      h('div',{style:card},
        h('p',{style:sec},`ðŸ“Š Excel Update â€” ${filterMonth} ${filterYear}`),
        h('p',{style:{fontSize:12,color:"#6b7280",marginBottom:12}},"Copy these totals (in "+data.baseCurrency+"):"),
        h('div',{style:{background:"#f0fdf4",borderRadius:12,padding:14,marginBottom:10}},
          h('div',{style:{fontWeight:700,fontSize:13,color:"#15803d",marginBottom:8}},"ðŸ’µ INCOME"),
          inc===0
            ?h('p',{style:{fontSize:12,color:"#9ca3af",margin:0}},"No income")
            :(data.incomeCategories||DEFAULT_INCOME_CATS).map(src=>{
                const entries=data.entries.filter(e=>e.month===filterMonth&&e.year===filterYear&&e.category===src.name&&e.type==="income");
                const t=entries.reduce((s,e)=>s+convertToBase(e.amount,e.currency,e.date),0);
                if(!t)return null;
                return h('div',{key:src.name,style:{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #bbf7d0",fontSize:13}},
                  h('span',{style:{color:"#374151"}},src.name),
                  h('strong',{style:{color:"#16a34a"}},fmt(t,data.baseCurrency))
                );
              })
        ),
        h('div',{style:{background:"#fef2f2",borderRadius:12,padding:14}},
          h('div',{style:{fontWeight:700,fontSize:13,color:"#b91c1c",marginBottom:8}},"ðŸ’¸ EXPENSES"),
          exp===0
            ?h('p',{style:{fontSize:12,color:"#9ca3af",margin:0}},"No expenses")
            :(data.expenseCategories||DEFAULT_EXPENSE_CATS).map(cat=>{
                const t=catTotal(filterMonth,filterYear,cat.name);
                if(!t)return null;
                return h('div',{key:cat.name,style:{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #fecaca",fontSize:13}},
                  h('span',{style:{color:"#374151"}},`${cat.icon} ${cat.name}`),
                  h('strong',{style:{color:"#dc2626"}},fmt(t,data.baseCurrency))
                );
              })
        )
      )
    );
  };

  return h('div',{style:{minHeight:"100vh",background:"linear-gradient(160deg,#1e1b4b 0%,#312e81 60%,#1e1b4b 100%)",fontFamily:"system-ui,-apple-system,sans-serif"}},
    h('div',{style:{background:"rgba(255,255,255,0.07)",backdropFilter:"blur(16px)",borderBottom:"1px solid rgba(255,255,255,0.1)",padding:"max(env(safe-area-inset-top),14px) 16px 14px",position:"sticky",top:0,zIndex:50,display:"flex",alignItems:"center",justifyContent:"space-between"}},
      h('div',{style:{fontWeight:800,fontSize:18,color:"#fff",letterSpacing:"-0.5px"}},"ðŸ’¼ FamilyBudget"),
      h('div',{style:{display:"flex",background:"rgba(255,255,255,0.08)",borderRadius:12,padding:3,gap:2}},
        [["log","Log"],["history","History"],["summary","Summary"]].map(([v,l])=>
          h('button',{key:v,onClick:()=>setView(v),style:{padding:"8px 12px",borderRadius:10,border:"none",background:view===v?"#fff":"transparent",color:view===v?"#1e1b4b":"rgba(255,255,255,0.65)",fontWeight:view===v?700:500,fontSize:13,cursor:"pointer"}},l)
        )
      ),
      h('div',{style:{display:"flex",gap:6,alignItems:"center"}},
        h('button',{onClick:()=>setShowSettings(true),style:{background:"rgba(255,255,255,0.1)",border:"none",color:"rgba(255,255,255,0.85)",borderRadius:20,padding:"6px 12px",cursor:"pointer",fontSize:13,fontWeight:700}},"âš™ï¸"),
        h('div',{style:{fontSize:12,fontWeight:700,color:"rgba(255,255,255,0.6)",background:"rgba(255,255,255,0.1)",padding:"4px 10px",borderRadius:20}},data.baseCurrency)
      )
    ),
    h('div',{style:{maxWidth:520,margin:"0 auto",padding:"16px 14px",paddingBottom:"calc(env(safe-area-inset-bottom,0px) + 80px)"}},
      view==="log"&&h(LogView),
      view==="history"&&h(HistoryView),
      view==="summary"&&h(SummaryView)
    ),
    showSettings&&h('div',{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"flex-start",justifyContent:"center",zIndex:250,overflowY:"auto",padding:"20px 0"}},
      h('div',{style:{background:"#fff",borderRadius:20,padding:"24px 20px",maxWidth:480,width:"90%",marginTop:20}},
        h('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}},
          h('h2',{style:{fontSize:18,fontWeight:800,margin:0,color:"#1e1b4b"}},"âš™ï¸ Settings"),
          h('button',{onClick:()=>{setShowSettings(false);setEditingCat(null);setShowResetConfirm(false);},style:{background:"none",border:"none",fontSize:24,cursor:"pointer",color:"#9ca3af"}},"âœ•")
        ),
        h('div',{style:{marginBottom:24}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Manage Categories"),
          h('div',{style:{display:"flex",gap:6,marginBottom:14}},
            h('button',{onClick:()=>setEditCatType("expense"),style:{flex:1,padding:"8px",border:`2px solid ${editCatType==="expense"?"#ef4444":"#e5e7eb"}`,borderRadius:10,background:editCatType==="expense"?"#fef2f2":"#fff",color:editCatType==="expense"?"#ef4444":"#6b7280",fontWeight:700,fontSize:13,cursor:"pointer"}},"ðŸ’¸ Expenses"),
            h('button',{onClick:()=>setEditCatType("income"),style:{flex:1,padding:"8px",border:`2px solid ${editCatType==="income"?"#22c55e":"#e5e7eb"}`,borderRadius:10,background:editCatType==="income"?"#f0fdf4":"#fff",color:editCatType==="income"?"#22c55e":"#6b7280",fontWeight:700,fontSize:13,cursor:"pointer"}},"ðŸ’µ Income")
          ),
          h('div',{style:{background:"#f9fafb",borderRadius:12,padding:14,marginBottom:12}},
            h('div',{style:{fontSize:12,fontWeight:700,color:"#6b7280",marginBottom:8}},editingCat!==null?"Edit":"Add New"),
            h('input',{type:"text",placeholder:"Category name",value:newCatName,onChange:e=>setNewCatName(e.target.value),style:{width:"100%",padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:14,marginBottom:8,boxSizing:"border-box"}}),
            h('div',{style:{display:"flex",gap:8,marginBottom:8}},
              h('input',{type:"text",placeholder:"Icon",value:newCatIcon,onChange:e=>setNewCatIcon(e.target.value),maxLength:2,style:{width:60,padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:18,textAlign:"center"}}),
              h('input',{type:"color",value:newCatColor,onChange:e=>setNewCatColor(e.target.value),style:{width:60,height:42,border:"2px solid #e5e7eb",borderRadius:8,cursor:"pointer"}}),
              h('button',{onClick:()=>editingCat!==null?updateCategory(editingCat):addCategory(),style:{flex:1,padding:"10px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:8,fontWeight:700,fontSize:13,cursor:"pointer"}},editingCat!==null?"Update":"+ Add")
            ),
            editingCat!==null&&h('button',{onClick:()=>{setEditingCat(null);setNewCatName("");setNewCatIcon("ðŸ“¦");setNewCatColor("#4A90D9");},style:{width:"100%",padding:"8px",background:"#f3f4f6",border:"none",borderRadius:8,fontSize:12,cursor:"pointer"}},"Cancel")
          ),
          h('div',{style:{maxHeight:240,overflowY:"auto"}},
            (editCatType==="expense"?(data.expenseCategories||DEFAULT_EXPENSE_CATS):(data.incomeCategories||DEFAULT_INCOME_CATS)).map((cat,idx)=>
              h('div',{key:idx,style:{display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderRadius:10,background:"#fff",border:"1px solid #e5e7eb",marginBottom:6}},
                h('div',{style:{width:32,height:32,borderRadius:8,background:`${cat.color}22`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16}},cat.icon),
                h('div',{style:{flex:1,fontWeight:600,fontSize:13,color:"#374151"}},cat.name),
                h('button',{onClick:()=>startEditCategory(idx,cat),style:{background:"#f3f4f6",border:"none",borderRadius:6,padding:"6px 10px",fontSize:11,cursor:"pointer",fontWeight:600}},"âœï¸"),
                h('button',{onClick:()=>deleteCategory(idx),style:{background:"#fee2e2",border:"none",borderRadius:6,padding:"6px 10px",fontSize:11,cursor:"pointer",fontWeight:600}},"ðŸ—‘ï¸")
              )
            )
          )
        ),
        h('div',{style:{marginBottom:24,borderTop:"1px solid #e5e7eb",paddingTop:20}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Manage Years"),
          h('div',{style:{display:"flex",gap:8,marginBottom:12}},
            h('input',{type:"number",placeholder:"e.g. 2031",value:newYear,onChange:e=>setNewYear(e.target.value),style:{flex:1,padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:14}}),
            h('button',{onClick:addYear,style:{padding:"10px 16px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:8,fontWeight:700,fontSize:13,cursor:"pointer"}},"+ Add")
          ),
          h('div',{style:{display:"flex",flexWrap:"wrap",gap:6}},
            years.map(y=>
              h('div',{key:y,style:{display:"flex",alignItems:"center",gap:6,padding:"6px 12px",background:"#f3f4f6",borderRadius:20}},
                h('span',{style:{fontWeight:600,fontSize:13}},y),
                years.length>1&&h('button',{onClick:()=>deleteYear(y),style:{background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:14,fontWeight:700}},"âœ•")
              )
            )
          )
        ),
        h('div',{style:{borderTop:"1px solid #e5e7eb",paddingTop:20}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Danger Zone"),
          !showResetConfirm
            ?h('button',{onClick:resetAllData,style:{width:"100%",padding:"12px",background:"#fee2e2",color:"#dc2626",border:"2px solid #fecaca",borderRadius:10,fontWeight:700,fontSize:14,cursor:"pointer"}},"ðŸ—‘ï¸ Reset All Data")
            :h('div',{style:{background:"#fef2f2",border:"2px solid #fecaca",borderRadius:10,padding:14}},
                h('p',{style:{fontSize:13,fontWeight:700,color:"#dc2626",marginBottom:10}},"âš ï¸ Delete ALL? Cannot undo!"),
                h('div',{style:{display:"flex",gap:8}},
                  h('button',{onClick:()=>setShowResetConfirm(false),style:{flex:1,padding:"10px",background:"#fff",border:"2px solid #e5e7eb",borderRadius:8,fontWeight:700,cursor:"pointer"}},"Cancel"),
                  h('button',{onClick:resetAllData,style:{flex:1,padding:"10px",background:"#dc2626",color:"#fff",border:"none",borderRadius:8,fontWeight:700,cursor:"pointer"}},"Delete")
                )
              )
        )
      )
    ),
    showFxModal&&h('div',{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:300}},
      h('div',{style:{background:"#fff",borderRadius:20,padding:24,maxWidth:350,width:"90%"}},
        h('h3',{style:{fontSize:16,fontWeight:800,marginBottom:12,color:"#1e1b4b"}},"ðŸ’± Exchange Rate Needed"),
        h('p',{style:{fontSize:13,color:"#6b7280",marginBottom:16}},`Enter today's rate for ${entryCurrency} â†’ ${data.baseCurrency}:`),
        h('input',{type:"number",inputMode:"decimal",placeholder:`1 ${entryCurrency} = ? ${data.baseCurrency}`,onKeyDown:e=>{if(e.key==="Enter") saveFxRate(e.target.value);},style:{width:"100%",padding:"12px",border:"2px solid #e5e7eb",borderRadius:10,fontSize:16,marginBottom:16,boxSizing:"border-box"}}),
        h('div',{style:{display:"flex",gap:8}},
          h('button',{onClick:()=>setShowFxModal(false),style:{flex:1,padding:"10px",background:"#f3f4f6",border:"none",borderRadius:10,fontWeight:700,cursor:"pointer"}},"Cancel"),
          h('button',{onClick:e=>{const input=e.target.parentElement.previousSibling;saveFxRate(input.value);},style:{flex:1,padding:"10px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:10,fontWeight:700,cursor:"pointer"}},"Save & Log")
        )
      )
    ),
    delConfirm&&h('div',{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200}},
      h('div',{style:{background:"#fff",borderRadius:20,padding:28,maxWidth:300,width:"90%",textAlign:"center"}},
        h('div',{style:{fontSize:42,marginBottom:10}},"ðŸ—‘ï¸"),
        h('div',{style:{fontWeight:800,fontSize:16,marginBottom:6}},"Delete entry?"),
        h('div',{style:{color:"#9ca3af",fontSize:13,marginBottom:22}},"Cannot undo"),
        h('div',{style:{display:"flex",gap:10}},
          h('button',{onClick:()=>setDelConfirm(null),style:{flex:1,padding:12,border:"2px solid #e5e7eb",borderRadius:12,background:"#fff",cursor:"pointer",fontWeight:700,fontSize:14}},"Cancel"),
          h('button',{onClick:()=>handleDelete(delConfirm),style:{flex:1,padding:12,border:"none",borderRadius:12,background:"#ef4444",color:"#fff",cursor:"pointer",fontWeight:700,fontSize:14}},"Delete")
        )
      )
    ),
    toast&&h(Toast,{msg:toast,onDone:()=>setToast(null)})
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));

  </script>
  <script>
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>