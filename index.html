<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="FamilyBudget"/>
  <meta name="theme-color" content="#1e1b4b"/>
  <link rel="manifest" href="manifest.json"/>
  <link rel="apple-touch-icon" href="icon.svg"/>
  <title>FamilyBudget</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
    html,body{height:100%;background:#1e1b4b;overscroll-behavior:none;}
    #root{min-height:100%;}
    input,select,button{font-family:inherit;}
    input[type=number]::-webkit-inner-spin-button{-webkit-appearance:none;}
    ::-webkit-scrollbar{width:4px;}
    ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:2px;}
    /* Safe area custom properties fallback */
    :root {
      --sat: env(safe-area-inset-top, 0px);
      --sab: env(safe-area-inset-bottom, 0px);
      --sal: env(safe-area-inset-left, 0px);
      --sar: env(safe-area-inset-right, 0px);
    }
    .topbar {
      padding-top: max(var(--sat), 16px);
      padding-bottom: 10px;
      padding-left: max(var(--sal), 16px);
      padding-right: max(var(--sar), 16px);
    }
    .main-content {
      padding-left: max(var(--sal), 14px);
      padding-right: max(var(--sar), 14px);
      padding-top: 16px;
      padding-bottom: max(calc(var(--sab) + 32px), 40px);
    }
    /* Smooth inputs on iOS */
    input, select, textarea {
      -webkit-appearance: none;
      appearance: none;
      border-radius: 12px;
    }
    select { background-image: none; }
    button { -webkit-appearance: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script>

const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
const CURRENCIES = ["SGD","USD","INR","GBP","EUR","AUD","MYR","JPY","HKD","CAD"];

const DEFAULT_EXPENSE_CATS = [
  { name: "Housing & Utilities", icon: "ðŸ ", color: "#4A90D9" },
  { name: "Groceries & Food", icon: "ðŸ›’", color: "#E67E22" },
  { name: "Transport", icon: "ðŸš—", color: "#8E44AD" },
  { name: "Children â€” School Fees", icon: "ðŸ«", color: "#F39C12" },
  { name: "Children â€” Tuition", icon: "ðŸ“š", color: "#F39C12" },
  { name: "Children â€” Activities", icon: "âš½", color: "#F39C12" },
  { name: "Children â€” Misc", icon: "ðŸŽ’", color: "#F39C12" },
  { name: "Insurance", icon: "ðŸ›¡ï¸", color: "#27AE60" },
  { name: "Healthcare", icon: "ðŸ¥", color: "#E74C3C" },
  { name: "Personal & Lifestyle", icon: "âœ¨", color: "#16A085" },
  { name: "Entertainment", icon: "ðŸŽ¬", color: "#2980B9" },
  { name: "Subscriptions", icon: "ðŸ“±", color: "#7F8C8D" },
  { name: "Domestic Help", icon: "ðŸ§¹", color: "#95A5A6" },
  { name: "Travel & Holidays", icon: "âœˆï¸", color: "#1ABC9C" },
  { name: "Savings & Investments", icon: "ðŸ’°", color: "#27AE60" },
  { name: "Other", icon: "ðŸ“¦", color: "#BDC3C7" },
];

const DEFAULT_INCOME_CATS = [
  { name: "Salary â€” Person 1", icon: "ðŸ‘¤", color: "#27AE60" },
  { name: "Salary â€” Person 2", icon: "ðŸ‘¤", color: "#2ECC71" },
  { name: "Bonus / Incentive", icon: "ðŸŽ¯", color: "#27AE60" },
  { name: "Rental Income", icon: "ðŸ¢", color: "#27AE60" },
  { name: "Other Income", icon: "ðŸ’µ", color: "#27AE60" },
];

const currSym = c => ({INR:"â‚¹",USD:"$",SGD:"S$",GBP:"Â£",EUR:"â‚¬",AUD:"A$",MYR:"RM",JPY:"Â¥",HKD:"HK$",CAD:"C$"}[c]||c+" ");
const todayStr = () => new Date().toISOString().slice(0,10);
const monthFromDate = d => MONTHS[new Date(d).getMonth()];
const yearFromDate = d => new Date(d).getFullYear();

const STORE_KEY = "fambudget_v5";
const loadData = () => { try { const r=localStorage.getItem(STORE_KEY); return r?JSON.parse(r):null; } catch{return null;} };
const saveData = d => { try { localStorage.setItem(STORE_KEY,JSON.stringify(d)); } catch{} };
const initData = () => ({
  baseCurrency:"SGD",
  fxRates:{},
  availableYears:[2026,2027,2028,2029,2030],
  entries:[],
  receipts:{},
  expenseCategories: DEFAULT_EXPENSE_CATS,
  incomeCategories: DEFAULT_INCOME_CATS
});

const { useState, useEffect, useRef, useCallback } = React;

function Toast({msg,onDone}) {
  useEffect(()=>{const t=setTimeout(onDone,2000);return()=>clearTimeout(t);},[]);
  return React.createElement('div',{style:{position:"fixed",bottom:28,left:"50%",transform:"translateX(-50%)",background:"#1a1a2e",color:"#fff",padding:"11px 24px",borderRadius:40,fontSize:13,fontWeight:700,zIndex:9999,boxShadow:"0 8px 32px rgba(0,0,0,0.4)",display:"flex",alignItems:"center",gap:8}},
    React.createElement('span',{style:{color:"#4ade80"}},"âœ“")," ",msg);
}

function CatPill({cat,selected,onClick}) {
  const active = selected===cat.name;
  return React.createElement('button',{onClick:()=>onClick(cat.name),style:{display:"flex",alignItems:"center",gap:5,padding:"9px 13px",borderRadius:30,border:`2px solid ${active?cat.color:"#e5e7eb"}`,background:active?`${cat.color}18`:"#f9fafb",color:active?cat.color:"#6b7280",fontSize:13,fontWeight:active?700:500,cursor:"pointer",transition:"all .15s",whiteSpace:"nowrap"}},
    React.createElement('span',null,cat.icon),React.createElement('span',null,cat.name));
}

const h = React.createElement;
const card = {background:"#fff",borderRadius:20,padding:"18px 16px",boxShadow:"0 2px 16px rgba(0,0,0,0.13)",marginBottom:12};
const sec = {fontSize:10,fontWeight:700,color:"#a0aec0",letterSpacing:2,textTransform:"uppercase",marginBottom:10};
const inp = {width:"100%",padding:"13px 14px",border:"1.5px solid #e8ecf0",borderRadius:14,fontSize:15,outline:"none",fontFamily:"inherit",background:"#f8fafc",boxSizing:"border-box",color:"#1a202c"};

// â”€â”€â”€ LogView defined OUTSIDE App so it's stable across renders â”€â”€â”€
function LogView({data,setData,showToast,cats,type,setType,category,setCategory,amount,setAmount,entryCurrency,setEntryCurrency,notes,setNotes,entryDate,setEntryDate,editId,setEditId,receiptImg,setReceiptImg,amtRef,handleSubmit,handleEdit,setDelConfirm,viewReceipt,convertToBase,fmt}) {
  const handleReceiptUpload = e=>{
    const file=e.target.files[0];
    if(!file) return showToast("Select an image");
    if(!file.type.startsWith('image/')) return showToast("Select an image");
    if(file.size>5*1024*1024) return showToast("Image too large (max 5MB)");
    const reader=new FileReader();
    reader.onload=ev=>{setReceiptImg(ev.target.result);showToast("Receipt attached!");};
    reader.readAsDataURL(file);
  };
  const removeReceipt=()=>{setReceiptImg(null);showToast("Receipt removed");};

  return h('div',null,
    h('div',{style:{...card,display:"flex",gap:8,alignItems:"center",padding:"11px 14px"}},
      h('span',{style:{fontSize:10,fontWeight:700,color:"#a0aec0",textTransform:"uppercase",letterSpacing:1,flexShrink:0}},"Base:"),
      ["SGD","USD","INR"].map(c=>h('button',{key:c,onClick:()=>setData(p=>({...p,baseCurrency:c})),style:{
        padding:"5px 14px",borderRadius:20,fontSize:12,fontWeight:700,
        border:`1.5px solid ${data.baseCurrency===c?"#312e81":"#e8ecf0"}`,
        background:data.baseCurrency===c?"#312e81":"#fff",
        color:data.baseCurrency===c?"#fff":"#6b7280",cursor:"pointer"
      }},c)),
    ),
    h('div',{style:card},
      editId&&h('div',{style:{background:"#fefce8",border:"1px solid #fde68a",borderRadius:12,padding:"10px 14px",marginBottom:14,display:"flex",justifyContent:"space-between",alignItems:"center"}},
        h('span',{style:{fontSize:13,fontWeight:700,color:"#92400e"}},"âœï¸ Editing entry"),
        h('button',{onClick:()=>{setEditId(null);setAmount("");setNotes("");setCategory("");},style:{background:"none",border:"none",cursor:"pointer",color:"#92400e",fontWeight:700,fontSize:20,lineHeight:1}},"âœ•")
      ),
      h('div',{style:{display:"flex",borderRadius:14,overflow:"hidden",border:"1.5px solid #e8ecf0",marginBottom:16}},
        [["expense","ðŸ’¸ Expense","#ef4444"],["income","ðŸ’µ Income","#22c55e"]].map(([t,l,col])=>
          h('button',{key:t,onClick:()=>{setType(t);setCategory("");},style:{flex:1,padding:"13px 0",border:"none",cursor:"pointer",background:type===t?col:"transparent",color:type===t?"#fff":"#9ca3af",fontWeight:700,fontSize:14,transition:"all .15s"}},l)
        )
      ),
      h('p',{style:sec},"Date"),
      h('input',{
        type:"date",
        value:entryDate,
        onChange:e=>setEntryDate(e.target.value),
        style:{...inp,marginBottom:14,fontSize:15,display:"block"}
      }),
      h('p',{style:sec},"Category"),
      h('div',{style:{display:"flex",flexWrap:"wrap",gap:7,marginBottom:16,maxHeight:160,overflowY:"auto",WebkitOverflowScrolling:"touch"}},
        cats.map(cat=>h(CatPill,{key:cat.name,cat,selected:category,onClick:setCategory}))
      ),
      h('p',{style:sec},"Amount & Currency"),
      h('div',{style:{display:"flex",gap:8,marginBottom:14}},
        h('div',{style:{position:"relative",flex:1}},
          h('span',{style:{position:"absolute",left:14,top:"50%",transform:"translateY(-50%)",fontSize:18,fontWeight:800,color:"#312e81",pointerEvents:"none"}},currSym(entryCurrency)),
          h('input',{ref:amtRef,type:"number",inputMode:"decimal",value:amount,onChange:e=>setAmount(e.target.value),placeholder:"0.00",style:{...inp,paddingLeft:44,fontSize:26,fontWeight:800,color:"#1a202c",border:"2px solid #312e81",background:"#f5f3ff",margin:0,lineHeight:1.2}})
        ),
        h('select',{value:entryCurrency,onChange:e=>setEntryCurrency(e.target.value),style:{...inp,width:88,padding:"12px 8px",fontSize:14,margin:0,fontWeight:600}},CURRENCIES.map(c=>h('option',{key:c,value:c},c)))
      ),
      entryCurrency!==data.baseCurrency&&(()=>{
        const rateKey=`${entryCurrency}_${data.baseCurrency}`;
        const rate=data.fxRates?.[rateKey];
        return h('div',{style:{background:rate?"#f0fdf4":"#fef9c3",border:`1px solid ${rate?"#bbf7d0":"#fde68a"}`,borderRadius:12,padding:"9px 14px",marginBottom:12,fontSize:12,color:rate?"#16a34a":"#92400e",fontWeight:600,display:"flex",alignItems:"center",gap:6}},
          rate
            ? `âœ“ Rate: 1 ${entryCurrency} = ${rate} ${data.baseCurrency}`
            : `âš ï¸ No rate for ${entryCurrency}â†’${data.baseCurrency}. Set in âš™ï¸ Settings.`
        );
      })(),
      h('p',{style:sec},"Notes (optional)"),
      h('input',{type:"text",value:notes,onChange:e=>setNotes(e.target.value),placeholder:"e.g. NTUC groceries...",style:{...inp,marginBottom:14}}),
      h('p',{style:sec},"Receipt (optional)"),
      !receiptImg
        ?h('label',{style:{display:"block",padding:"14px",border:"2px dashed #e2e8f0",borderRadius:14,textAlign:"center",cursor:"pointer",background:"#f8fafc",marginBottom:14}},
          h('input',{type:"file",accept:"image/*",onChange:handleReceiptUpload,style:{display:"none"}}),
          h('div',{style:{fontSize:13,color:"#a0aec0",fontWeight:500}},"ðŸ“¸ Camera or ðŸ–¼ï¸ Photos")
        )
        :h('div',{style:{position:"relative",marginBottom:14}},
          h('img',{src:receiptImg,style:{width:"100%",maxHeight:200,objectFit:"contain",borderRadius:14,border:"1.5px solid #e8ecf0"}}),
          h('button',{onClick:removeReceipt,style:{position:"absolute",top:8,right:8,background:"rgba(239,68,68,0.9)",color:"#fff",border:"none",borderRadius:"50%",width:32,height:32,cursor:"pointer",fontSize:16,display:"flex",alignItems:"center",justifyContent:"center"}},"âœ•")
        ),
      h('button',{
        onClick:handleSubmit,
        disabled:!category||!amount,
        style:{
          width:"100%",padding:"15px",border:"none",borderRadius:16,
          background:(!category||!amount)?"#e8ecf0":"linear-gradient(135deg,#312e81,#4338ca)",
          color:(!category||!amount)?"#a0aec0":"#fff",
          fontWeight:800,fontSize:16,cursor:(!category||!amount)?"not-allowed":"pointer",
          letterSpacing:"-0.2px",transition:"opacity .15s",
          boxShadow:(!category||!amount)?"none":"0 4px 16px rgba(67,56,202,0.4)"
        }
      }, editId?"âœï¸ Update Entry":`+ Log ${type==="expense"?"Expense":"Income"}`)
    ),
    h('div',{style:card},
      h('p',{style:sec},"Recent Entries"),
      data.entries.length===0&&h('div',{style:{textAlign:"center",padding:"28px 0"}},
        h('div',{style:{fontSize:36,marginBottom:8}},"ðŸ“Š"),
        h('p',{style:{color:"#a0aec0",fontSize:14,fontWeight:500}},"No entries yet")
      ),
      [...data.entries].reverse().slice(0,8).map(e=>{
        const allCats=[...(data.expenseCategories||DEFAULT_EXPENSE_CATS),...(data.incomeCategories||DEFAULT_INCOME_CATS)];
        const cat=allCats.find(c=>c.name===e.category)||{icon:"ðŸ“¦",color:"#ccc"};
        return h('div',{key:e.id,style:{display:"flex",alignItems:"center",gap:11,padding:"11px 0",borderBottom:"1px solid #f0f4f8"}},
          h('div',{style:{width:40,height:40,borderRadius:12,flexShrink:0,background:`${cat.color}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}},cat.icon),
          h('div',{style:{flex:1,minWidth:0}},
            h('div',{style:{fontWeight:700,fontSize:13,color:"#1a202c",marginBottom:2}},e.category),
            h('div',{style:{fontSize:11,color:"#a0aec0"}},e.date+(e.notes?` Â· ${e.notes}`:"")),
          ),
          h('div',{style:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}},
            data.receipts?.[e.id]&&h('button',{onClick:()=>viewReceipt(e.id),style:{background:"#dbeafe",border:"none",borderRadius:6,padding:"3px 7px",fontSize:10,cursor:"pointer"}},"ðŸ“Ž"),
            h('div',{style:{fontWeight:800,fontSize:14,color:e.type==="expense"?"#ef4444":"#22c55e"}},
              (e.type==="expense"?"âˆ’":"+")+fmt(e.amount,e.currency)),
            e.currency!==data.baseCurrency&&h('div',{style:{fontSize:10,color:"#a0aec0"}},`â‰ˆ${fmt(convertToBase(e.amount,e.currency),data.baseCurrency)}`)
          ),
          h('button',{onClick:()=>handleEdit(e),style:{background:"#f0f4f8",border:"none",borderRadius:8,width:32,height:32,cursor:"pointer",fontSize:13,flexShrink:0}},"âœï¸"),
          h('button',{onClick:()=>setDelConfirm(e.id),style:{background:"#fee2e2",border:"none",borderRadius:8,width:32,height:32,cursor:"pointer",fontSize:13,flexShrink:0}},"ðŸ—‘")
        );
      })
    )
  );
}

function HistoryView({data,filterMonth,setFilterMonth,filterYear,setFilterYear,years,convertToBase,fmt,handleEdit,setDelConfirm,viewReceipt,handleBackup,handleRestore,exportCSV}) {
  const monthEntries=(m,y)=>data.entries.filter(e=>e.month===m&&e.year===y);
  const monthTotal=(m,y,t)=>monthEntries(m,y).filter(e=>e.type===t).reduce((s,e)=>s+convertToBase(e.amount,e.currency),0);
  const entries=[...monthEntries(filterMonth,filterYear)].reverse();
  const inc=monthTotal(filterMonth,filterYear,"income");
  const exp=monthTotal(filterMonth,filterYear,"expense");
  const allCats=[...(data.expenseCategories||DEFAULT_EXPENSE_CATS),...(data.incomeCategories||DEFAULT_INCOME_CATS)];
  const getCat=name=>allCats.find(c=>c.name===name)||{icon:"ðŸ“¦",color:"#ccc"};
  return h('div',null,
    h('div',{style:{...card,display:"flex",gap:8,alignItems:"center",flexWrap:"wrap",padding:"12px 16px"}},
      h('select',{value:filterMonth,onChange:e=>setFilterMonth(e.target.value),style:{...inp,width:"auto",padding:"7px 12px",fontSize:13}},MONTHS.map(m=>h('option',{key:m},m))),
      h('select',{value:filterYear,onChange:e=>setFilterYear(Number(e.target.value)),style:{...inp,width:85,padding:"7px 12px",fontSize:13}},years.map(y=>h('option',{key:y},y))),
      h('div',{style:{marginLeft:"auto",display:"flex",gap:6}},
        h('button',{onClick:handleBackup,style:{padding:"7px 14px",background:"#16a34a",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"ðŸ’¾"),
        h('button',{onClick:handleRestore,style:{padding:"7px 14px",background:"#7c3aed",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"ðŸ“¥"),
        h('button',{onClick:exportCSV,style:{padding:"7px 14px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:10,cursor:"pointer",fontWeight:700,fontSize:12}},"â¬‡ CSV")
      )
    ),
    h('div',{style:{...card,display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10}},
      [["Income",inc,"#22c55e","#f0fdf4","ðŸ’µ"],["Expenses",exp,"#ef4444","#fef2f2","ðŸ’¸"],["Net",inc-exp,inc-exp>=0?"#3b82f6":"#ef4444","#eff6ff","ðŸ“Š"]].map(([l,v,col,bg,ic])=>
        h('div',{key:l,style:{textAlign:"center",padding:"12px 6px",background:bg,borderRadius:12}},
          h('div',{style:{fontSize:18}},ic),
          h('div',{style:{fontSize:10,color:"#9ca3af",fontWeight:700,margin:"4px 0 2px",textTransform:"uppercase"}},l),
          h('div',{style:{fontSize:12,fontWeight:800,color:col}},(v<0?"âˆ’":"")+fmt(Math.abs(v),data.baseCurrency))
        )
      )
    ),
    h('div',{style:card},
      h('p',{style:sec},`${filterMonth} ${filterYear} â€” ${entries.length} entries (in ${data.baseCurrency})`),
      entries.length===0&&h('p',{style:{color:"#9ca3af",textAlign:"center",padding:"24px 0",fontSize:14}},"No entries"),
      entries.map(e=>{
        const cat=getCat(e.category);
        return h('div',{key:e.id,style:{display:"flex",alignItems:"center",gap:12,padding:"12px 0",borderBottom:"1px solid #f3f4f6"}},
          h('div',{style:{width:40,height:40,borderRadius:11,flexShrink:0,background:`${cat.color}18`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:18}},cat.icon),
          h('div',{style:{flex:1,minWidth:0}},
            h('div',{style:{fontWeight:700,fontSize:13,color:"#111827"}},e.category),
            h('div',{style:{fontSize:11,color:"#9ca3af"}},e.date+(e.notes?` Â· ${e.notes}`:"")),
          ),
          h('div',{style:{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}},
            data.receipts?.[e.id]&&h('button',{onClick:()=>viewReceipt(e.id),style:{background:"#dbeafe",border:"none",borderRadius:6,padding:"4px 8px",fontSize:11,cursor:"pointer"}},"ðŸ“Ž"),
            h('div',{style:{fontWeight:800,fontSize:14,color:e.type==="expense"?"#ef4444":"#22c55e"}},
              (e.type==="expense"?"âˆ’":"+")+fmt(convertToBase(e.amount,e.currency),data.baseCurrency)),
            e.currency!==data.baseCurrency&&h('div',{style:{fontSize:10,color:"#9ca3af"}},`${fmt(e.amount,e.currency)}`)
          ),
          h('button',{onClick:()=>handleEdit(e),style:{background:"#f3f4f6",border:"none",borderRadius:8,width:30,height:30,cursor:"pointer",fontSize:13}},"âœï¸"),
          h('button',{onClick:()=>setDelConfirm(e.id),style:{background:"#fee2e2",border:"none",borderRadius:8,width:30,height:30,cursor:"pointer",fontSize:13}},"ðŸ—‘")
        );
      })
    )
  );
}

function SummaryView({data,filterMonth,setFilterMonth,filterYear,setFilterYear,years,convertToBase,fmt}) {
  const [tab,setTab] = React.useState("month");

  // â”€â”€ helpers â”€â”€
  const yearEntries  = y => data.entries.filter(e=>e.year===y);
  const monthEntries = (m,y) => data.entries.filter(e=>e.month===m&&e.year===y);

  const sumType = (entries,t) => entries.filter(e=>e.type===t).reduce((s,e)=>s+convertToBase(e.amount,e.currency),0);
  const sumCat  = (entries,c) => entries.filter(e=>e.category===c).reduce((s,e)=>s+convertToBase(e.amount,e.currency),0);

  // â”€â”€ monthly â”€â”€
  const mEntries = monthEntries(filterMonth,filterYear);
  const mInc=sumType(mEntries,"income"), mExp=sumType(mEntries,"expense"), mNet=mInc-mExp;
  const mRate=mInc>0?(mNet/mInc*100).toFixed(1):"â€”";

  // â”€â”€ yearly â”€â”€
  const now = new Date();
  const currentYear = now.getFullYear();
  const isPartial = filterYear===currentYear;
  // For YTD: only include months up to current month
  const ytdMonthIdx = now.getMonth(); // 0-based
  const yAll = yearEntries(filterYear);
  const yEntries = isPartial ? yAll.filter(e=>MONTHS.indexOf(e.month)<=ytdMonthIdx) : yAll;
  const yInc=sumType(yEntries,"income"), yExp=sumType(yEntries,"expense"), yNet=yInc-yExp;
  const yRate=yInc>0?(yNet/yInc*100).toFixed(1):"â€”";
  // monthly breakdown for year chart
  const monthlyExp = MONTHS.map((m,i)=>{
    if(isPartial && i>ytdMonthIdx) return null;
    return {month:m,value:sumType(monthEntries(m,filterYear),"expense"),inc:sumType(monthEntries(m,filterYear),"income")};
  }).filter(Boolean);
  const maxMonthlyVal = Math.max(...monthlyExp.map(x=>Math.max(x.value,x.inc)),1);

  const childCats=["Children â€” School Fees","Children â€” Tuition","Children â€” Activities","Children â€” Misc"];

  const StatsGrid = ({inc,exp,net,rate}) =>
    h('div',{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:18}},
      [["Total Income",fmt(inc,data.baseCurrency),"#16a34a","#f0fdf4","ðŸ’µ"],
       ["Total Expenses",fmt(exp,data.baseCurrency),"#dc2626","#fef2f2","ðŸ’¸"],
       ["Net Savings",(net<0?"âˆ’":"")+fmt(Math.abs(net),data.baseCurrency),net>=0?"#2563eb":"#dc2626","#eff6ff","ðŸ’°"],
       ["Savings Rate",`${rate}%`,"#7c3aed","#f5f3ff","ðŸ“Š"]
      ].map(([l,v,col,bg,ic])=>
        h('div',{key:l,style:{padding:"15px 13px",borderRadius:14,background:bg}},
          h('div',{style:{fontSize:20}},ic),
          h('div',{style:{fontSize:10,color:"#9ca3af",fontWeight:700,marginTop:5,textTransform:"uppercase",letterSpacing:1}},l),
          h('div',{style:{fontSize:15,fontWeight:800,color:col,marginTop:2}},v)
        )
      )
    );

  const CatBreakdown = ({entries,totalExp}) => {
    if(totalExp===0) return h('p',{style:{color:"#a0aec0",fontSize:13,textAlign:"center",padding:"12px 0"}},"No expenses");
    return h('div',null,
      (data.expenseCategories||DEFAULT_EXPENSE_CATS).map(cat=>{
        const t=sumCat(entries.filter(e=>e.type==="expense"),cat.name);
        if(!t) return null;
        const pct=totalExp>0?Math.min(100,(t/totalExp)*100):0;
        return h('div',{key:cat.name,style:{marginBottom:10}},
          h('div',{style:{display:"flex",justifyContent:"space-between",fontSize:13,marginBottom:4}},
            h('span',{style:{fontWeight:600,color:"#374151"}},`${cat.icon} ${cat.name}`),
            h('span',{style:{fontWeight:700,color:cat.color}},`${fmt(t,data.baseCurrency)} `,
              h('span',{style:{color:"#9ca3af",fontWeight:400}},`(${pct.toFixed(1)}%)`))
          ),
          h('div',{style:{height:6,borderRadius:4,background:"#f0f4f8",overflow:"hidden"}},
            h('div',{style:{height:"100%",borderRadius:4,background:cat.color,width:`${pct}%`,transition:"width .5s ease"}})
          )
        );
      })
    );
  };

  const ChildrenCard = ({entries}) => {
    const total=childCats.reduce((s,c)=>s+sumCat(entries,c),0);
    if(!total) return null;
    return h('div',{style:{marginTop:4}},
      h('p',{style:{...sec,marginTop:16}},"ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦ Children's Costs"),
      childCats.map(cn=>{
        const t=sumCat(entries,cn);
        if(!t) return null;
        return h('div',{key:cn,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"9px 13px",borderRadius:10,marginBottom:6,background:"#fefce8",borderLeft:"3px solid #f59e0b"}},
          h('span',{style:{fontSize:13,fontWeight:600,color:"#374151"}},cn),
          h('span',{style:{fontWeight:700,color:"#d97706"}},fmt(t,data.baseCurrency))
        );
      }),
      h('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"11px 13px",borderRadius:10,background:"#fef3c7",borderLeft:"3px solid #f59e0b"}},
        h('span',{style:{fontWeight:800,color:"#92400e"}},"Total Children"),
        h('span',{style:{fontWeight:800,color:"#d97706",fontSize:15}},fmt(total,data.baseCurrency))
      )
    );
  };

  return h('div',null,
    // â”€â”€ Filter bar â”€â”€
    h('div',{style:{...card,padding:"11px 14px"}},
      h('div',{style:{display:"flex",gap:8,alignItems:"center",marginBottom:10}},
        h('select',{value:filterMonth,onChange:e=>setFilterMonth(e.target.value),style:{...inp,width:"auto",padding:"7px 12px",fontSize:13,flex:1}},MONTHS.map(m=>h('option',{key:m},m))),
        h('select',{value:filterYear,onChange:e=>setFilterYear(Number(e.target.value)),style:{...inp,width:90,padding:"7px 12px",fontSize:13}},years.map(y=>h('option',{key:y},y)))
      ),
      // Month / Year tab toggle
      h('div',{style:{display:"flex",background:"#f0f4f8",borderRadius:12,padding:3,gap:2}},
        [["month","ðŸ“… Monthly"],["year","ðŸ“† Yearly"]].map(([t,l])=>
          h('button',{key:t,onClick:()=>setTab(t),style:{
            flex:1,padding:"8px 0",borderRadius:9,border:"none",
            background:tab===t?"#fff":"transparent",
            color:tab===t?"#312e81":"#6b7280",
            fontWeight:tab===t?700:500,fontSize:13,cursor:"pointer",
            boxShadow:tab===t?"0 1px 4px rgba(0,0,0,0.1)":"none",
            transition:"all .15s"
          }},l)
        )
      )
    ),

    // â•â• MONTHLY TAB â•â•
    tab==="month"&&h('div',null,
      h('div',{style:card},
        h('p',{style:sec},`${filterMonth} ${filterYear} Â· in ${data.baseCurrency}`),
        h(StatsGrid,{inc:mInc,exp:mExp,net:mNet,rate:mRate}),
        h('p',{style:sec},"Expense Breakdown"),
        h(CatBreakdown,{entries:mEntries,totalExp:mExp}),
        h(ChildrenCard,{entries:mEntries})
      )
    ),

    // â•â• YEARLY TAB â•â•
    tab==="year"&&h('div',null,
      h('div',{style:card},
        h('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:14}},
          h('p',{style:{...sec,margin:0}},`${filterYear} Â· in ${data.baseCurrency}`),
          isPartial&&h('span',{style:{
            fontSize:10,fontWeight:700,color:"#7c3aed",background:"#f5f3ff",
            padding:"3px 9px",borderRadius:20,letterSpacing:0.5
          }},"YTD thru "+filterMonth)
        ),
        h(StatsGrid,{inc:yInc,exp:yExp,net:yNet,rate:yRate}),

        // â”€â”€ Monthly bar chart â”€â”€
        yEntries.length>0&&h('div',{style:{marginBottom:18}},
          h('p',{style:sec},"Month-by-Month"),
          h('div',{style:{display:"flex",alignItems:"flex-end",gap:4,height:80,marginBottom:6}},
            monthlyExp.map(({month,value,inc})=>{
              const expH=Math.round((value/maxMonthlyVal)*72);
              const incH=Math.round((inc/maxMonthlyVal)*72);
              return h('div',{key:month,style:{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:2}},
                h('div',{style:{width:"100%",display:"flex",gap:1,alignItems:"flex-end",height:74}},
                  h('div',{style:{flex:1,height:incH||2,background:"#22c55e",borderRadius:"3px 3px 0 0",minHeight:2,opacity:0.85}}),
                  h('div',{style:{flex:1,height:expH||2,background:"#ef4444",borderRadius:"3px 3px 0 0",minHeight:2,opacity:0.85}})
                ),
                h('div',{style:{fontSize:8,color:"#a0aec0",fontWeight:600,marginTop:2}},month.slice(0,1))
              );
            })
          ),
          h('div',{style:{display:"flex",gap:12,justifyContent:"center"}},
            [["#22c55e","Income"],["#ef4444","Expenses"]].map(([col,label])=>
              h('div',{key:label,style:{display:"flex",alignItems:"center",gap:4,fontSize:11,color:"#6b7280"}},
                h('div',{style:{width:8,height:8,borderRadius:2,background:col}}),label
              )
            )
          )
        ),

        h('p',{style:sec},"Expense Breakdown"),
        h(CatBreakdown,{entries:yEntries,totalExp:yExp}),
        h(ChildrenCard,{entries:yEntries})
      ),

      // â”€â”€ Month-by-month table â”€â”€
      yEntries.length>0&&h('div',{style:card},
        h('p',{style:sec},`Monthly breakdown Â· ${filterYear}`),
        h('div',{style:{display:"grid",gridTemplateColumns:"auto 1fr 1fr 1fr",gap:"8px 10px",alignItems:"center"}},
          ["Month","Income","Expenses","Net"].map(h2=>
            h('div',{key:h2,style:{fontSize:10,fontWeight:700,color:"#a0aec0",textTransform:"uppercase",letterSpacing:1}},h2)
          ).concat(
            monthlyExp.flatMap(({month,value,inc})=>{
              const net=inc-value;
              return [
                h('div',{key:month+"m",style:{fontSize:13,fontWeight:600,color:"#374151"}},month),
                h('div',{key:month+"i",style:{fontSize:13,fontWeight:700,color:"#16a34a"}},inc>0?fmt(inc,data.baseCurrency):"â€”"),
                h('div',{key:month+"e",style:{fontSize:13,fontWeight:700,color:"#dc2626"}},value>0?fmt(value,data.baseCurrency):"â€”"),
                h('div',{key:month+"n",style:{fontSize:13,fontWeight:700,color:net>=0?"#2563eb":"#dc2626"}},(net<0?"âˆ’":"")+fmt(Math.abs(net),data.baseCurrency))
              ];
            })
          )
        )
      )
    )
  );
}

function App() {
  const [data,setData] = useState(()=>loadData()||initData());
  const [view,setView] = useState("log");
  const [type,setType] = useState("expense");
  const [category,setCategory] = useState("");
  const [amount,setAmount] = useState("");
  const [entryCurrency,setEntryCurrency] = useState(data.baseCurrency||"SGD");
  const [notes,setNotes] = useState("");
  const [entryDate,setEntryDate] = useState(todayStr());
  const [filterMonth,setFilterMonth] = useState(MONTHS[new Date().getMonth()]);
  const [filterYear,setFilterYear] = useState((data.availableYears||[2026])[0]);
  const [toast,setToast] = useState(null);
  const [editId,setEditId] = useState(null);
  const [delConfirm,setDelConfirm] = useState(null);
  const [receiptImg,setReceiptImg] = useState(null);
  const [showSettings,setShowSettings] = useState(false);
  const [editCatType,setEditCatType] = useState("expense");
  const [editingCat,setEditingCat] = useState(null);
  const [newCatName,setNewCatName] = useState("");
  const [newCatIcon,setNewCatIcon] = useState("ðŸ“¦");
  const [newCatColor,setNewCatColor] = useState("#4A90D9");
  const [showResetConfirm,setShowResetConfirm] = useState(false);
  const [newYear,setNewYear] = useState("");
  // FX rate editing state
  const [fxFromCurr,setFxFromCurr] = useState("USD");
  const [fxRateInput,setFxRateInput] = useState("");
  const amtRef = useRef();

  useEffect(()=>{
    const timer = setTimeout(()=>saveData(data),500);
    return ()=>clearTimeout(timer);
  },[data]);

  const cats = type==="expense"?(data.expenseCategories||DEFAULT_EXPENSE_CATS):(data.incomeCategories||DEFAULT_INCOME_CATS);
  const showToast = m=>setToast(m);
  const years = data.availableYears||[2026];

  // Simplified: use global rate (no date key)
  const convertToBase = useCallback((amt,curr) => {
    if(curr===data.baseCurrency) return amt;
    const rateKey = `${curr}_${data.baseCurrency}`;
    const rate = data.fxRates?.[rateKey];
    if(rate) return amt * rate;
    return amt; // fallback 1:1
  }, [data.baseCurrency, data.fxRates]);

  const fmt = (n,c) => `${currSym(c||data.baseCurrency)}${Math.abs(Number(n)).toLocaleString("en-SG",{minimumFractionDigits:2,maximumFractionDigits:2})}`;

  const handleSubmit = () => {
    if(!category) return showToast("Pick a category");
    if(!amount||isNaN(amount)||Number(amount)<=0) return showToast("Enter valid amount");
    const month=monthFromDate(entryDate), year=yearFromDate(entryDate);
    const amt = Number(amount);

    if(editId){
      setData(p=>({...p,entries:p.entries.map(e=>e.id===editId?{...e,date:entryDate,month,year,type,category,amount:amt,currency:entryCurrency,notes}:e)}));
      setEditId(null); showToast("Updated!");
    } else {
      const newId=Date.now();
      const newEntry={id:newId,date:entryDate,month,year,type,category,amount:amt,currency:entryCurrency,notes};
      setData(p=>{
        const updated={...p,entries:[...p.entries,newEntry]};
        if(receiptImg) updated.receipts={...(p.receipts||{}),[newId]:receiptImg};
        return updated;
      });
      showToast(type==="expense"?"Expense logged!":"Income logged!");
    }
    setAmount(""); setNotes(""); setCategory(""); setReceiptImg(null); setEntryCurrency(data.baseCurrency);
    setTimeout(()=>amtRef.current?.focus(),50);
  };

  const handleEdit = e=>{setEditId(e.id);setType(e.type);setCategory(e.category);setAmount(String(e.amount));setEntryCurrency(e.currency||data.baseCurrency);setNotes(e.notes||"");setEntryDate(e.date);setView("log");};
  const handleDelete = id=>{setData(p=>({...p,entries:p.entries.filter(e=>e.id!==id)}));setDelConfirm(null);showToast("Deleted");};

  const exportCSV=()=>{
    const mEntries=data.entries.filter(e=>e.month===filterMonth&&e.year===filterYear);
    const rows=[["Date","Month","Year","Type","Category","Amount","Currency","Amount in "+data.baseCurrency,"Notes"]];
    mEntries.forEach(e=>rows.push([e.date,e.month,e.year,e.type,e.category,e.amount,e.currency,convertToBase(e.amount,e.currency).toFixed(2),e.notes||""]));
    const csv=rows.map(r=>r.map(c=>`"${c}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download=`budget_${filterMonth}_${filterYear}.csv`;a.click();
    showToast("CSV exported!");
  };

  const handleBackup=()=>{
    const backup={version:"3.0",exportDate:new Date().toISOString(),data};
    const json=JSON.stringify(backup,null,2);
    const blob=new Blob([json],{type:"application/json"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download=`FamilyBudget_Backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    showToast("Backup downloaded!");
  };

  const handleRestore=()=>{
    const input=document.createElement("input");
    input.type="file";input.accept=".json";
    input.onchange=e=>{
      const file=e.target.files[0];
      if(!file) return;
      const reader=new FileReader();
      reader.onload=event=>{
        try{
          const backup=JSON.parse(event.target.result);
          if(!backup.data||!backup.data.entries) return showToast("Invalid backup");
          if(data.entries.length>0){
            if(confirm(`Replace ${data.entries.length} entries with backup (${backup.data.entries.length} entries)?`)){
              setData(backup.data);showToast(`Restored ${backup.data.entries.length} entries!`);
            }
          } else {
            setData(backup.data);showToast(`Restored ${backup.data.entries.length} entries!`);
          }
        }catch{showToast("Error reading file");}
      };
      reader.readAsText(file);
    };
    input.click();
  };

  const viewReceipt=id=>{
    const img=data.receipts?.[id];
    if(!img) return;
    const win=window.open();
    win.document.write(`<html><head><title>Receipt</title><style>body{margin:0;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#000;}</style></head><body><img src="${img}" style="max-width:100%;max-height:100vh;"/></body></html>`);
  };

  const addCategory=()=>{
    if(!newCatName.trim()) return showToast("Enter category name");
    const newCat={name:newCatName.trim(),icon:newCatIcon,color:newCatColor};
    setData(p=>({
      ...p,
      [editCatType==="expense"?"expenseCategories":"incomeCategories"]:[
        ...(editCatType==="expense"?p.expenseCategories||DEFAULT_EXPENSE_CATS:p.incomeCategories||DEFAULT_INCOME_CATS),
        newCat
      ]
    }));
    setNewCatName("");setNewCatIcon("ðŸ“¦");setNewCatColor("#4A90D9");
    showToast("Category added!");
  };

  const updateCategory=idx=>{
    if(!newCatName.trim()) return showToast("Enter category name");
    setData(p=>{
      const key=editCatType==="expense"?"expenseCategories":"incomeCategories";
      const cs=[...(p[key]||[])];
      cs[idx]={...cs[idx],name:newCatName.trim(),icon:newCatIcon,color:newCatColor};
      return {...p,[key]:cs};
    });
    setEditingCat(null);setNewCatName("");setNewCatIcon("ðŸ“¦");setNewCatColor("#4A90D9");
    showToast("Category updated!");
  };

  const deleteCategory=idx=>{
    if(!confirm("Delete this category?")) return;
    setData(p=>{
      const key=editCatType==="expense"?"expenseCategories":"incomeCategories";
      const cs=[...(p[key]||[])];
      cs.splice(idx,1);
      return {...p,[key]:cs};
    });
    showToast("Category deleted!");
  };

  const startEditCategory=(idx,cat)=>{
    setEditingCat(idx);setNewCatName(cat.name);setNewCatIcon(cat.icon);setNewCatColor(cat.color);
  };

  const addYear=()=>{
    const y = parseInt(newYear);
    if(!y || y<2020 || y>2050) return showToast("Enter year 2020-2050");
    if(years.includes(y)) return showToast("Year already exists");
    setData(p=>({...p,availableYears:[...years,y].sort((a,b)=>a-b)}));
    setNewYear("");
    showToast("Year added!");
  };

  const deleteYear=(y)=>{
    if(years.length<=1) return showToast("Need at least 1 year");
    setData(p=>({...p,availableYears:years.filter(yr=>yr!==y)}));
    showToast("Year removed!");
  };

  const resetAllData=()=>{
    if(!showResetConfirm){setShowResetConfirm(true);return;}
    setData(initData());
    setShowResetConfirm(false);
    setShowSettings(false);
    showToast("All data reset!");
  };

  const saveFxRate=()=>{
    const r=parseFloat(fxRateInput);
    if(!r||r<=0) return showToast("Enter a valid rate");
    const rateKey=`${fxFromCurr}_${data.baseCurrency}`;
    setData(p=>({...p,fxRates:{...(p.fxRates||{}),[rateKey]:r}}));
    setFxRateInput("");
    showToast(`Rate saved: 1 ${fxFromCurr} = ${r} ${data.baseCurrency}`);
  };

  const otherCurrencies = CURRENCIES.filter(c=>c!==data.baseCurrency);

  return h('div',{style:{minHeight:"100vh",minHeight:"100dvh",background:"linear-gradient(160deg,#1e1b4b 0%,#312e81 55%,#1e3a5f 100%)",fontFamily:"-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif"}},
    // â”€â”€â”€ Top bar â”€â”€â”€
    h('div',{className:"topbar",style:{
      background:"rgba(20,18,60,0.92)",
      backdropFilter:"blur(20px)",
      WebkitBackdropFilter:"blur(20px)",
      borderBottom:"1px solid rgba(255,255,255,0.08)",
      position:"sticky",
      top:0,
      zIndex:50,
    }},
      h('div',{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:10,maxWidth:520,margin:"0 auto"}},
        // Title
        h('div',{style:{fontWeight:800,fontSize:15,color:"#fff",letterSpacing:"-0.3px",flexShrink:0,display:"flex",alignItems:"center",gap:6}},
          h('span',{style:{fontSize:18}},"ðŸ’¼"),
          h('span',null,"Budget")
        ),
        // Nav tabs â€” centered pill
        h('div',{style:{display:"flex",background:"rgba(255,255,255,0.1)",borderRadius:22,padding:3,gap:2,flex:"1 1 auto",maxWidth:210,minWidth:0}},
          [["log","Log"],["history","History"],["summary","Summary"]].map(([v,l])=>
            h('button',{key:v,onClick:()=>setView(v),style:{
              flex:1,padding:"7px 2px",borderRadius:18,border:"none",
              background:view===v?"#fff":"transparent",
              color:view===v?"#1e1b4b":"rgba(255,255,255,0.6)",
              fontWeight:view===v?700:500,fontSize:11,cursor:"pointer",
              transition:"all .15s",whiteSpace:"nowrap"
            }},l)
          )
        ),
        // Settings + currency
        h('div',{style:{display:"flex",gap:6,alignItems:"center",flexShrink:0}},
          h('button',{onClick:()=>setShowSettings(true),style:{
            background:"rgba(255,255,255,0.12)",border:"none",
            color:"#fff",borderRadius:20,width:34,height:34,
            cursor:"pointer",fontSize:15,display:"flex",alignItems:"center",justifyContent:"center"
          }},"âš™ï¸"),
          h('div',{style:{
            fontSize:11,fontWeight:700,color:"rgba(255,255,255,0.75)",
            background:"rgba(255,255,255,0.12)",padding:"5px 9px",borderRadius:14,letterSpacing:0.5
          }},data.baseCurrency)
        )
      )
    ),
    // â”€â”€â”€ Main content â”€â”€â”€
    h('div',{className:"main-content",style:{maxWidth:520,margin:"0 auto"}},
      view==="log"&&h(LogView,{data,setData,showToast,cats,type,setType,category,setCategory,amount,setAmount,entryCurrency,setEntryCurrency,notes,setNotes,entryDate,setEntryDate,editId,setEditId,receiptImg,setReceiptImg,amtRef,handleSubmit,handleEdit,setDelConfirm,viewReceipt,convertToBase,fmt}),
      view==="history"&&h(HistoryView,{data,filterMonth,setFilterMonth,filterYear,setFilterYear,years,convertToBase,fmt,handleEdit,setDelConfirm,viewReceipt,handleBackup,handleRestore,exportCSV}),
      view==="summary"&&h(SummaryView,{data,filterMonth,setFilterMonth,filterYear,setFilterYear,years,convertToBase,fmt})
    ),
    // â”€â”€â”€ Settings modal â”€â”€â”€
    showSettings&&h('div',{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.75)",display:"flex",alignItems:"flex-start",justifyContent:"center",zIndex:250,overflowY:"auto",paddingTop:"max(var(--sat), 20px)",paddingBottom:"max(var(--sab), 20px)",paddingLeft:12,paddingRight:12}},
      h('div',{style:{background:"#fff",borderRadius:24,padding:"24px 20px",maxWidth:480,width:"100%",marginTop:8,marginBottom:8}},
        h('div',{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}},
          h('h2',{style:{fontSize:18,fontWeight:800,margin:0,color:"#1e1b4b"}},"âš™ï¸ Settings"),
          h('button',{onClick:()=>{setShowSettings(false);setEditingCat(null);setShowResetConfirm(false);},style:{background:"none",border:"none",fontSize:24,cursor:"pointer",color:"#9ca3af"}},"âœ•")
        ),
        // â”€â”€ FX Rates Section â”€â”€
        h('div',{style:{marginBottom:24}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:4,textTransform:"uppercase",letterSpacing:1}},"ðŸ’± Exchange Rates"),
          h('p',{style:{fontSize:12,color:"#9ca3af",marginBottom:12}},"Set global rates vs "+data.baseCurrency+". These apply to all entries."),
          h('div',{style:{display:"flex",gap:8,marginBottom:10}},
            h('select',{value:fxFromCurr,onChange:e=>setFxFromCurr(e.target.value),style:{flex:1,padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:14}},
              otherCurrencies.map(c=>h('option',{key:c,value:c},c))
            ),
            h('input',{type:"number",inputMode:"decimal",value:fxRateInput,onChange:e=>setFxRateInput(e.target.value),placeholder:`Rate in ${data.baseCurrency}`,style:{flex:2,padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:14}}),
            h('button',{onClick:saveFxRate,style:{padding:"10px 14px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:8,fontWeight:700,fontSize:13,cursor:"pointer"}},"Save")
          ),
          h('div',{style:{background:"#f9fafb",borderRadius:10,padding:12}},
            h('div',{style:{fontSize:11,fontWeight:700,color:"#6b7280",marginBottom:8,textTransform:"uppercase",letterSpacing:1}},"Current Rates â†’ "+data.baseCurrency),
            otherCurrencies.map(c=>{
              const rateKey=`${c}_${data.baseCurrency}`;
              const rate=data.fxRates?.[rateKey];
              return h('div',{key:c,style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 0",borderBottom:"1px solid #e5e7eb",fontSize:13}},
                h('span',{style:{color:"#374151",fontWeight:600}},`1 ${c} =`),
                h('div',{style:{display:"flex",alignItems:"center",gap:8}},
                  rate
                    ? h('span',{style:{fontWeight:700,color:"#16a34a"}},`${rate} ${data.baseCurrency}`)
                    : h('span',{style:{color:"#9ca3af",fontStyle:"italic"}},"not set"),
                  rate&&h('button',{onClick:()=>{setData(p=>{const fx={...(p.fxRates||{})};delete fx[rateKey];return {...p,fxRates:fx};});showToast("Rate removed");},style:{background:"#fee2e2",border:"none",borderRadius:4,padding:"2px 6px",fontSize:11,cursor:"pointer",color:"#dc2626"}},"âœ•")
                )
              );
            })
          )
        ),
        // â”€â”€ Categories â”€â”€
        h('div',{style:{marginBottom:24,borderTop:"1px solid #e5e7eb",paddingTop:20}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Manage Categories"),
          h('div',{style:{display:"flex",gap:6,marginBottom:14}},
            h('button',{onClick:()=>setEditCatType("expense"),style:{flex:1,padding:"8px",border:`2px solid ${editCatType==="expense"?"#ef4444":"#e5e7eb"}`,borderRadius:10,background:editCatType==="expense"?"#fef2f2":"#fff",color:editCatType==="expense"?"#ef4444":"#6b7280",fontWeight:700,fontSize:13,cursor:"pointer"}},"ðŸ’¸ Expenses"),
            h('button',{onClick:()=>setEditCatType("income"),style:{flex:1,padding:"8px",border:`2px solid ${editCatType==="income"?"#22c55e":"#e5e7eb"}`,borderRadius:10,background:editCatType==="income"?"#f0fdf4":"#fff",color:editCatType==="income"?"#22c55e":"#6b7280",fontWeight:700,fontSize:13,cursor:"pointer"}},"ðŸ’µ Income")
          ),
          h('div',{style:{background:"#f9fafb",borderRadius:12,padding:14,marginBottom:12}},
            h('div',{style:{fontSize:12,fontWeight:700,color:"#6b7280",marginBottom:8}},editingCat!==null?"Edit":"Add New"),
            h('input',{type:"text",placeholder:"Category name",value:newCatName,onChange:e=>setNewCatName(e.target.value),style:{width:"100%",padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:14,marginBottom:8,boxSizing:"border-box"}}),
            h('div',{style:{display:"flex",gap:8,marginBottom:8}},
              h('input',{type:"text",placeholder:"Icon",value:newCatIcon,onChange:e=>setNewCatIcon(e.target.value),maxLength:2,style:{width:60,padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:18,textAlign:"center"}}),
              h('input',{type:"color",value:newCatColor,onChange:e=>setNewCatColor(e.target.value),style:{width:60,height:42,border:"2px solid #e5e7eb",borderRadius:8,cursor:"pointer"}}),
              h('button',{onClick:()=>editingCat!==null?updateCategory(editingCat):addCategory(),style:{flex:1,padding:"10px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:8,fontWeight:700,fontSize:13,cursor:"pointer"}},editingCat!==null?"Update":"+ Add")
            ),
            editingCat!==null&&h('button',{onClick:()=>{setEditingCat(null);setNewCatName("");setNewCatIcon("ðŸ“¦");setNewCatColor("#4A90D9");},style:{width:"100%",padding:"8px",background:"#f3f4f6",border:"none",borderRadius:8,fontSize:12,cursor:"pointer"}},"Cancel")
          ),
          h('div',{style:{maxHeight:240,overflowY:"auto"}},
            (editCatType==="expense"?(data.expenseCategories||DEFAULT_EXPENSE_CATS):(data.incomeCategories||DEFAULT_INCOME_CATS)).map((cat,idx)=>
              h('div',{key:idx,style:{display:"flex",alignItems:"center",gap:10,padding:"10px 12px",borderRadius:10,background:"#fff",border:"1px solid #e5e7eb",marginBottom:6}},
                h('div',{style:{width:32,height:32,borderRadius:8,background:`${cat.color}22`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:16}},cat.icon),
                h('div',{style:{flex:1,fontWeight:600,fontSize:13,color:"#374151"}},cat.name),
                h('button',{onClick:()=>startEditCategory(idx,cat),style:{background:"#f3f4f6",border:"none",borderRadius:6,padding:"6px 10px",fontSize:11,cursor:"pointer",fontWeight:600}},"âœï¸"),
                h('button',{onClick:()=>deleteCategory(idx),style:{background:"#fee2e2",border:"none",borderRadius:6,padding:"6px 10px",fontSize:11,cursor:"pointer",fontWeight:600}},"ðŸ—‘ï¸")
              )
            )
          )
        ),
        // â”€â”€ Manage Years â”€â”€
        h('div',{style:{marginBottom:24,borderTop:"1px solid #e5e7eb",paddingTop:20}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Manage Years"),
          h('div',{style:{display:"flex",gap:8,marginBottom:12}},
            h('input',{type:"number",placeholder:"e.g. 2031",value:newYear,onChange:e=>setNewYear(e.target.value),style:{flex:1,padding:"10px",border:"2px solid #e5e7eb",borderRadius:8,fontSize:14}}),
            h('button',{onClick:addYear,style:{padding:"10px 16px",background:"#1e1b4b",color:"#fff",border:"none",borderRadius:8,fontWeight:700,fontSize:13,cursor:"pointer"}},"+ Add")
          ),
          h('div',{style:{display:"flex",flexWrap:"wrap",gap:6}},
            years.map(y=>
              h('div',{key:y,style:{display:"flex",alignItems:"center",gap:6,padding:"6px 12px",background:"#f3f4f6",borderRadius:20}},
                h('span',{style:{fontWeight:600,fontSize:13}},y),
                years.length>1&&h('button',{onClick:()=>deleteYear(y),style:{background:"none",border:"none",color:"#dc2626",cursor:"pointer",fontSize:14,fontWeight:700}},"âœ•")
              )
            )
          )
        ),
        // â”€â”€ Danger Zone â”€â”€
        h('div',{style:{borderTop:"1px solid #e5e7eb",paddingTop:20}},
          h('h3',{style:{fontSize:14,fontWeight:700,color:"#6b7280",marginBottom:12,textTransform:"uppercase",letterSpacing:1}},"Danger Zone"),
          !showResetConfirm
            ?h('button',{onClick:resetAllData,style:{width:"100%",padding:"12px",background:"#fee2e2",color:"#dc2626",border:"2px solid #fecaca",borderRadius:10,fontWeight:700,fontSize:14,cursor:"pointer"}},"ðŸ—‘ï¸ Reset All Data")
            :h('div',{style:{background:"#fef2f2",border:"2px solid #fecaca",borderRadius:10,padding:14}},
                h('p',{style:{fontSize:13,fontWeight:700,color:"#dc2626",marginBottom:10}},"âš ï¸ Delete ALL? Cannot undo!"),
                h('div',{style:{display:"flex",gap:8}},
                  h('button',{onClick:()=>setShowResetConfirm(false),style:{flex:1,padding:"10px",background:"#fff",border:"2px solid #e5e7eb",borderRadius:8,fontWeight:700,cursor:"pointer"}},"Cancel"),
                  h('button',{onClick:resetAllData,style:{flex:1,padding:"10px",background:"#dc2626",color:"#fff",border:"none",borderRadius:8,fontWeight:700,cursor:"pointer"}},"Delete")
                )
              )
        )
      )
    ),
    // â”€â”€â”€ Delete confirm â”€â”€â”€
    delConfirm&&h('div',{style:{position:"fixed",inset:0,background:"rgba(0,0,0,0.65)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:200}},
      h('div',{style:{background:"#fff",borderRadius:20,padding:28,maxWidth:300,width:"90%",textAlign:"center"}},
        h('div',{style:{fontSize:42,marginBottom:10}},"ðŸ—‘ï¸"),
        h('div',{style:{fontWeight:800,fontSize:16,marginBottom:6}},"Delete entry?"),
        h('div',{style:{color:"#9ca3af",fontSize:13,marginBottom:22}},"Cannot undo"),
        h('div',{style:{display:"flex",gap:10}},
          h('button',{onClick:()=>setDelConfirm(null),style:{flex:1,padding:12,border:"2px solid #e5e7eb",borderRadius:12,background:"#fff",cursor:"pointer",fontWeight:700,fontSize:14}},"Cancel"),
          h('button',{onClick:()=>handleDelete(delConfirm),style:{flex:1,padding:12,border:"none",borderRadius:12,background:"#ef4444",color:"#fff",cursor:"pointer",fontWeight:700,fontSize:14}},"Delete")
        )
      )
    ),
    toast&&h(Toast,{msg:toast,onDone:()=>setToast(null)})
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));

  </script>
  <script>
    if('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>
